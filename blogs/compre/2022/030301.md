---
title: 地理地图信息展示小组件
date: 2022-03-03
tags:
 - 维格小程序
categories:
 - 日志
---


::: tip
 维格表租房小组件，帮助租房者在租房的时候在地图上进行租房信息对比选出自己心仪的小根据地。
 git地址[地理地图信息展示小组件](https://github.com/laboonly/widgets-rent-map)
:::

## 功能介绍
本小程序根据表格里面的出租房信息在地图上显示各个出租房的位置，到公司的路线规划，以及详细信息。
帮助租房的同学更加立体的对比各个出租房的优缺点，找出自己心仪的房子。

## 使用说明
请先获取高德api的key[高德地图apikey获取](https://lbs.amap.com/api/javascript-api/guide/abc/prepare)，
填入src/map.tsx的securityCode和apiKey，启动小程序之后选择，名称，地址，价格，联系方式对应表格的列，以及填入地图中心(公司)。

## 开发经历
  接触到维格表一段时间了解到小程序这个功能之后，正在找工作和准备租房的我脑袋里就想到
如果能用维格表小程序管理租房信息能够实现我找到最优房子的需求就好了，正好实践一下自己对React的学习。

  初步功能设想就是，能用地图去展示出租房的信息，利用高德api展示各个出租房到公司的通勤时间以及距离。
因为之前做过地图方面功能，所以设想就是首先根据表格的地址列的信息，在地图上展示出租房以及公司地点。

  想好了就开干,首先第一步就是要加载地图,在申请好了高德apikey之后发现高德api更新了JSAPI 2.0 版本，
不仅增加了安全密钥，还支持npm引入，可惜在一番捣鼓之后，一直失败没加载出来，原以为是我密钥填入原因，
结果在咨询了维格的研发同学之后，才知道可能是因为维格对iframe支持有问题，高德地图是确定可以使用的，
于是我决定使用高德地图的 [JS API v1.4.15](https://lbs.amap.com/api/javascript-api/changelog) 版本。
在看了git上关于react高德的地图的组件之后一方面我想加深对React的学习，一方面我想使用高德地图原生api，
我觉得借鉴一下REACT-AMAP源码自己写。首先就是高德JS API的加载，copy了一下REACT-AMAP代码，地图成功加载了。

  接下来就是标点，首先表格里面使用的是地址的文字地址，所以要使用高德地图的 
[AMap.Geocoder](https://lbs.amap.com/api/javascript-api/reference/lnglat-to-address#m_AMap.Geocoder) 
编码插件。将地址描述信息转换成地理坐标（经纬度)，

  然后是路线规划是需要 [AMap.Transfer](https://lbs.amap.com/api/javascript-api/reference/route-search#m_AMap.Transfer) 
插件，在一顿瞎敲之后，我发现，这些插件都是异步加载包括高德地图的API，尤其是地图编码，每个地址编码都需要通过高德的api异步查询，
于是我使用了Promise.all()来管理插件对象的使用。

  标点，跟路线规划完成之后，开始着手于点击标点租房信息的展示功能，这方面高德地图信息弹窗需要DOM字符串，
所以我需要在每次点击标点之后拿到新的信息展示DOM，我尝试了React*Refs 转发*但是效果并不是很理想，因为每次都需要新建一个实例，
没有达到组件复用的效果,尝试了ReacDOM.render Api也没有成功，这里还需要改进。

  在预想的第一计划的功能完成之后，我发现代码变得很杂乱，有些函数添加了太多功能，于是我开始计划小重构一下，总结思路。
将地图api加载以及插件加载放在通用的js文件里面，然后整理整个组件的生命周期，弄清楚不同参数引起什么变化，清理各种函数功能，整理代码变得规范，
修改UI自定义地图UI，讲TS完全的运用起来。修改完代码之后，代码变得更清晰，看着舒服多了。

一些bug以及未完成的还有后续功能的设想：
1. AMapUI SimpleMarker在保存代码之后有时候会加载失败
2. 实现信息弹窗信息可以修改
3. ts类型问题，高德地图1.4.15 API版本没有声明文件
4. 高德地图key 改为配置填入
5. 拓展地图功能不仅仅只为租房服务
	